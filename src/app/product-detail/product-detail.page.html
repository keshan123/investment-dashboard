<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/market"></ion-back-button>
    </ion-buttons>
    <ion-title>Product Detail</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Top Info Row -->
  <div *ngIf="!loading && product" style="max-width: 420px; margin: 24px auto 0 auto; padding: 0 20px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;">
      <!-- Left Column -->
      <div style="display: flex; flex-direction: column; gap: 6px; flex: 1;">
        <span style="font-size: 1.25em; font-weight: 700; color: #fff;">{{ product.name }}</span>
        <span style="color: #888; font-size: 1em; font-weight: 500;">{{ product.symbol }}</span>
      </div>
      <!-- Right Column -->
      <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px; flex: 1;">
        <span style="font-size: 1.2em; font-weight: 600; color: #fff;">
          {{ priceTick?.price | number:'1.2-2' }}
        </span>
        <span [style.color]="getPriceColor()" style="font-size: 1em; font-weight: 500;">
          <ng-container *ngIf="priceTick">
            {{ priceTick.price - (priceTick.history[0] || priceTick.price) | number:'1.2-2' }}
            (
            <ng-container *ngIf="priceTick.history[0]">
              {{ ((priceTick.price - priceTick.history[0]) / priceTick.history[0] * 100) | number:'1.1-2' }}%
            </ng-container>
            )
          </ng-container>
        </span>
      </div>
    </div>
  </div>

  <!-- Line Graph -->
  <div *ngIf="priceTick" style="max-width: 420px; margin: 24px auto 0 auto; padding: 0 20px 16px 20px;">
    <svg width="100%" height="80" viewBox="0 0 140 80">
      <polyline
        *ngIf="priceTick.history.length > 1"
        [attr.points]="getLineGraphPoints(priceTick.history, 140, 80)"
        fill="none"
        [attr.stroke]="konamiMario.getLineColors()[0]"
        stroke-width="2"
      />
      <!-- Optionally, show the current price as a dot -->
      <circle
        *ngIf="priceTick.history.length > 0"
        [attr.cx]="getCurrentX(priceTick.history, 140)"
        [attr.cy]="getCurrentY(priceTick.history, 80)"
        r="3"
        [attr.fill]="konamiMario.getLineColors()[0]"
        stroke="#232323"
        stroke-width="1"
      />
    </svg>
  </div>

  <!-- Buy Button -->
  <div style="max-width: 420px; margin: 0 auto; padding: 0 20px 16px 20px;">
    <form (ngSubmit)="buy()" style="display: flex; flex-direction: column; gap: 16px;">
      <ion-item style="--background: transparent; --border-radius: 12px;">
        <ion-label position="floating">Quantity</ion-label>
        <ion-input type="number" [(ngModel)]="quantity" name="quantity" min="1" (ngModelChange)="onQuantityChange($event)"></ion-input>
      </ion-item>
      <div style="margin-top: 1em; font-size: 1.1em;">
        <strong>Total:</strong>
        {{ (priceTick?.price || price || 0) * validQuantity | number:'1.2-2' }}
      </div>
      <ion-button expand="block" type="submit" [disabled]="!validQuantity" style="--background: #19B074; font-weight: 600; font-size: 1.1em; justify-content: center; align-items: center; display: flex;">
        Buy
      </ion-button>
    </form>
  </div>

  <!-- Key Statistics Section -->
  <div style="max-width: 420px; margin: 0 auto 32px auto; padding: 0 20px;">
    <h3 style="margin-top: 24px; margin-bottom: 12px; color: #fff; font-size: 1.15em; font-weight: 700; letter-spacing: 0.01em;">Key Statistics</h3>
    <div *ngIf="product?.description" style="color: #bbb; font-size: 1em; line-height: 1.5;">
      {{ product.description }}
    </div>
  </div>
</ion-content>
